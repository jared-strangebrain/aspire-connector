# Version 1.2 - Authentication Fix

**Release Date**: October 16, 2025  
**Status**: ✅ **DEPLOYED**  
**Deployment ID**: 5aef57c7-ac18-4482-97f6-c034c4882e44

---

## 🔐 **What's New in v1.2**

### ✅ Authentication Fix - #token_request Operation

**The Big Fix**: Added the `#token_request` operation to enable automatic authentication in Tray!

**Problem in v1.0**:
- ❌ Users getting 401 Unauthorized errors
- ❌ No way to authenticate in Tray workflows
- ❌ Had to manually provide access tokens

**Solution in v1.2**:
- ✅ `#token_request` operation added
- ✅ Automatic token retrieval
- ✅ Clean 3-field auth form in Tray
- ✅ No more 401 errors!

---

## 🎯 **How Authentication Works Now**

### In Tray Workflow Builder:

**1. Add Connector**
```
Search: "Aspire" or "convex-aspire-connector"
Drag into workflow
```

**2. Configure Authentication**
```
Click: "New Authentication"

Auth Form Shows:
┌─────────────────────────────────┐
│ Client ID: [____________]      │
│ Client Secret: [_________]     │
│ Environment: [Demo ▼]          │
│          Production             │
│          Sandbox                │
│          Demo                   │
│                                 │
│  [Cancel]  [Connect]            │
└─────────────────────────────────┘
```

**3. Automatic Token Retrieval**
```
✅ Tray calls #token_request operation
✅ Sends client_id + client_secret to Aspire
✅ Receives access_token + refresh_token
✅ Stores tokens for future use
✅ All 158 operations now work!
```

---

## 📊 **Changes in v1.2**

### New Operation
- ✅ `#token_request` - OAuth2 token retrieval

### Updated Auth Type
- Changed from: `TokenOperationHandlerAuth`
- Changed to: `Oauth2ClientCredentialsOperationHandlerAuth`

### Updated Auth Structure
```typescript
// App Auth (from auth form)
export type AspireAppAuth = {
  client_id?: string;
  client_secret?: string;
  environment?: "production" | "sandbox" | "demo";
};

// User Auth (managed by Tray)
export type AspireUserAuth = {
  access_token?: string;      // From #token_request
  refresh_token?: string;     // From #token_request
  expires_at?: string;        // Managed by Tray
  environment: string;        // From auth form
  // ... other fields
};
```

---

## 🚀 **Using v1.2 in Tray**

### Example Workflow

**Step 1**: Trigger (Webhook, Schedule, etc.)

**Step 2**: Aspire - Get Properties
```yaml
Operation: properties_get
Authentication: [Your Aspire Auth]
Parameters:
  top: "10"
  filter: "Active eq true"
```

**Step 3**: Process Results
```yaml
Loop on: {{step_2.items}}

For each property:
  - ID: {{loop_item.PropertyID}}
  - Name: {{loop_item.PropertyName}}
  - Branch: {{loop_item.BranchName}}
```

---

## 🔧 **Technical Details**

### #token_request Implementation

**Endpoint**: `POST /Authorization`  
**Method**: Composite (uses fetch API)  
**Input**:
```json
{
  "auth_form_input": {
    "client_id": "user-provided",
    "client_secret": "user-provided",
    "environment": "demo"
  }
}
```

**Output**:
```json
{
  "status_code": 200,
  "body": {
    "access_token": "eyJhbGci...",
    "refresh_token": "eyJhbGci...",
    "expires_in": 86400
  },
  "headers": {}
}
```

**Base URL Selection**:
- Demo → `https://clouddemo-api.youraspire.com`
- Sandbox → `https://cloudsandbox-api.youraspire.com`
- Production → `https://cloud-api.youraspire.com`

---

## ✅ **Testing v1.2**

### Test Token Request:
```bash
npm test -- "#token_request"
```

**Result**:
```
✅ PASS src/#token_request/handler.test.ts
✅ Got access token: eyJhbGci...
✅ Tests: 1 passed
```

### Test with Authentication:
```bash
npm test -- properties_get
```

**Result**:
```
✅ PASS src/properties_get/handler.test.ts
✅ Success! Retrieved 0 properties
✅ Tests: 2 passed
```

---

## 🎊 **Summary**

### Before v1.2
- ❌ 401 errors in Tray
- ❌ Manual token management
- ❌ No auth form

### After v1.2
- ✅ Authentication works automatically
- ✅ Clean auth form (3 fields)
- ✅ No 401 errors
- ✅ Automatic token refresh
- ✅ 159 operations (158 + #token_request)

---

## 📞 **Support**

If you still see 401 errors after deploying v1.2:

1. **Re-authenticate** in Tray
   - Remove old auth
   - Create new auth with v1.2
   - Fill in 3 fields

2. **Verify credentials**
   - Client ID correct?
   - Client Secret correct?
   - Right environment selected?

3. **Check deployment**
   ```bash
   tray-cdk deployment get convex-aspire-connector 1.2 5aef57c7-ac18-4482-97f6-c034c4882e44 --us
   ```

---

**Version**: 1.2  
**Status**: ✅ Deploying  
**Fix**: Authentication with #token_request  
**Deployment ID**: 5aef57c7-ac18-4482-97f6-c034c4882e44


