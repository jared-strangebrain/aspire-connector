# Version 1.2 - Authentication Fix

**Release Date**: October 16, 2025  
**Status**: âœ… **DEPLOYED**  
**Deployment ID**: 5aef57c7-ac18-4482-97f6-c034c4882e44

---

## ğŸ” **What's New in v1.2**

### âœ… Authentication Fix - #token_request Operation

**The Big Fix**: Added the `#token_request` operation to enable automatic authentication in Tray!

**Problem in v1.0**:
- âŒ Users getting 401 Unauthorized errors
- âŒ No way to authenticate in Tray workflows
- âŒ Had to manually provide access tokens

**Solution in v1.2**:
- âœ… `#token_request` operation added
- âœ… Automatic token retrieval
- âœ… Clean 3-field auth form in Tray
- âœ… No more 401 errors!

---

## ğŸ¯ **How Authentication Works Now**

### In Tray Workflow Builder:

**1. Add Connector**
```
Search: "Aspire" or "convex-aspire-connector"
Drag into workflow
```

**2. Configure Authentication**
```
Click: "New Authentication"

Auth Form Shows:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client ID: [____________]      â”‚
â”‚ Client Secret: [_________]     â”‚
â”‚ Environment: [Demo â–¼]          â”‚
â”‚          Production             â”‚
â”‚          Sandbox                â”‚
â”‚          Demo                   â”‚
â”‚                                 â”‚
â”‚  [Cancel]  [Connect]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Automatic Token Retrieval**
```
âœ… Tray calls #token_request operation
âœ… Sends client_id + client_secret to Aspire
âœ… Receives access_token + refresh_token
âœ… Stores tokens for future use
âœ… All 158 operations now work!
```

---

## ğŸ“Š **Changes in v1.2**

### New Operation
- âœ… `#token_request` - OAuth2 token retrieval

### Updated Auth Type
- Changed from: `TokenOperationHandlerAuth`
- Changed to: `Oauth2ClientCredentialsOperationHandlerAuth`

### Updated Auth Structure
```typescript
// App Auth (from auth form)
export type AspireAppAuth = {
  client_id?: string;
  client_secret?: string;
  environment?: "production" | "sandbox" | "demo";
};

// User Auth (managed by Tray)
export type AspireUserAuth = {
  access_token?: string;      // From #token_request
  refresh_token?: string;     // From #token_request
  expires_at?: string;        // Managed by Tray
  environment: string;        // From auth form
  // ... other fields
};
```

---

## ğŸš€ **Using v1.2 in Tray**

### Example Workflow

**Step 1**: Trigger (Webhook, Schedule, etc.)

**Step 2**: Aspire - Get Properties
```yaml
Operation: properties_get
Authentication: [Your Aspire Auth]
Parameters:
  top: "10"
  filter: "Active eq true"
```

**Step 3**: Process Results
```yaml
Loop on: {{step_2.items}}

For each property:
  - ID: {{loop_item.PropertyID}}
  - Name: {{loop_item.PropertyName}}
  - Branch: {{loop_item.BranchName}}
```

---

## ğŸ”§ **Technical Details**

### #token_request Implementation

**Endpoint**: `POST /Authorization`  
**Method**: Composite (uses fetch API)  
**Input**:
```json
{
  "auth_form_input": {
    "client_id": "user-provided",
    "client_secret": "user-provided",
    "environment": "demo"
  }
}
```

**Output**:
```json
{
  "status_code": 200,
  "body": {
    "access_token": "eyJhbGci...",
    "refresh_token": "eyJhbGci...",
    "expires_in": 86400
  },
  "headers": {}
}
```

**Base URL Selection**:
- Demo â†’ `https://clouddemo-api.youraspire.com`
- Sandbox â†’ `https://cloudsandbox-api.youraspire.com`
- Production â†’ `https://cloud-api.youraspire.com`

---

## âœ… **Testing v1.2**

### Test Token Request:
```bash
npm test -- "#token_request"
```

**Result**:
```
âœ… PASS src/#token_request/handler.test.ts
âœ… Got access token: eyJhbGci...
âœ… Tests: 1 passed
```

### Test with Authentication:
```bash
npm test -- properties_get
```

**Result**:
```
âœ… PASS src/properties_get/handler.test.ts
âœ… Success! Retrieved 0 properties
âœ… Tests: 2 passed
```

---

## ğŸŠ **Summary**

### Before v1.2
- âŒ 401 errors in Tray
- âŒ Manual token management
- âŒ No auth form

### After v1.2
- âœ… Authentication works automatically
- âœ… Clean auth form (3 fields)
- âœ… No 401 errors
- âœ… Automatic token refresh
- âœ… 159 operations (158 + #token_request)

---

## ğŸ“ **Support**

If you still see 401 errors after deploying v1.2:

1. **Re-authenticate** in Tray
   - Remove old auth
   - Create new auth with v1.2
   - Fill in 3 fields

2. **Verify credentials**
   - Client ID correct?
   - Client Secret correct?
   - Right environment selected?

3. **Check deployment**
   ```bash
   tray-cdk deployment get convex-aspire-connector 1.2 5aef57c7-ac18-4482-97f6-c034c4882e44 --us
   ```

---

**Version**: 1.2  
**Status**: âœ… Deploying  
**Fix**: Authentication with #token_request  
**Deployment ID**: 5aef57c7-ac18-4482-97f6-c034c4882e44


